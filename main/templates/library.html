{% extends 'base.html' %}

{% block content %}
{% include 'navbar.html' %}
<style>
    body{
        background-color: #F2E8C6;
      }
      .h-100{
        background-color: #A73121;
      }
</style>
{% if user.is_superuser %}
<a class="btn btn-danger" href="/admin/main/book/" role="button">ADD/EDIT/DELETE</a>
{% endif %}

<div class="container mt-3">
    <input type="text" id="searchInput" class="form-control" placeholder="Search for books..." style="margin:12px;">
</div>

<table id="catalog"></table>

<script>
    async function getBooks() {
        return fetch("{% url 'main:get_books' %}").then((res) => res.json())
    }

    async function searchBooks(query) {
        const books = await getBooks();
        const filteredBooks = books.filter(item => item.fields.title.toLowerCase().includes(query.toLowerCase()));
        return filteredBooks;
    }

    async function refreshBooks(query = '') {
        document.getElementById("catalog").innerHTML = ""
        const books = await (query ? searchBooks(query) : getBooks())
        let htmlString = `<div class="container">
            <div class="row row-cols-1 row-cols-md-4 g-4">`
        books.forEach((item) => {
            htmlString += `\n<div class="col mx">
                <div class="card" style="width: 300px; height: 400px;">
                    <div style="width: 100%; height: 100%; overflow: hidden;">
                        <img src="${item.fields.image_l}" style="object-fit: cover; width: 100%; height: 100%;" class="card-img-top" alt="...">
                    </div>
                    <div class="card-body">
                        <h5 class="card-title">${item.fields.title}</h5>
                        <h6 class="card-subtitle mb-2 text-muted">${item.fields.isbn}</h6>
                    </div>
                    <div class="card-footer">
                        <button type="button" class="btn btn-outline-success" onclick="addItemToList(${item.pk})">Add</button>
                    </div>
                </div>
            </div>` 
        })
        htmlString += `</div>
        </div>`
        
        document.getElementById("catalog").innerHTML = htmlString
    }

    document.getElementById("searchInput").addEventListener("input", function() {
        const query = this.value.trim();
        refreshBooks(query);
    });

    async function addItemToList(itemId) {
        const response = await fetch("/add_to_list/" + itemId);
        if (response.status === 200) {
            // Handle success, e.g., show a message to the user
            console.log('Item added to the cart');
        } else {
            // Handle any errors or show an error message
            console.error('Failed to add the item to the cart');
        }
    }

    refreshBooks()
</script>

{% endblock content %}